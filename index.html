<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 伴唱系統 (人聲消除版)</title>
    <!-- 引入 Tailwind CSS 方便快速美化介面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 提供更美觀的字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 自定義樣式 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #111827; /* 深灰色背景 */
        }
        .lyrics-container {
            height: 250px; /* 稍微減少歌詞區域高度 */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .lyrics-container::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari and Opera */
        }
        .lyric-line {
            transition: all 0.3s ease-in-out;
            opacity: 0.5;
            transform: scale(0.95);
            padding: 8px 16px;
            margin: 4px 0;
            border-radius: 8px;
        }
        .lyric-line.active {
            color: #34D399; /* 亮綠色 */
            opacity: 1;
            transform: scale(1.05);
            background-color: rgba(52, 211, 153, 0.1);
            font-weight: 700;
        }
        /* 美化檔案上傳按鈕 */
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 2px dashed #4B5563;
            display: inline-block;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            text-align: center;
        }
        .custom-file-upload:hover {
            background-color: #374151;
            border-color: #6B7280;
        }
        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        /* 美化 Audio 播放器 */
        audio {
            filter: sepia(20%) saturate(70%) grayscale(1) contrast(99%) invert(12%);
            width: 100%;
            border-radius: 8px;
        }
        /* 美化開關 Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4B5563;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #34D399;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body class="text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- 標題和說明 -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white">AI 伴唱系統</h1>
            <p class="text-gray-400 mt-2">可載入任何人聲音樂，並嘗試消除人聲</p>
        </div>

        <!-- 檔案上傳區域 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label for="audio-input" class="custom-file-upload">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l7 3-7 10z"></path></svg>
                <span id="audio-file-name">選擇音樂檔案</span>
            </label>
            <input type="file" id="audio-input" accept="audio/*">

            <label for="lrc-input" class="custom-file-upload">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span id="lrc-file-name">選擇歌詞檔案 (.lrc)</span>
            </label>
            <input type="file" id="lrc-input" accept=".lrc">
        </div>
        
        <!-- 功能控制 -->
        <div class="flex items-center justify-center bg-gray-900/50 rounded-lg p-4">
            <span class="mr-4 font-semibold text-lg">消除人聲</span>
            <label class="switch">
                <input type="checkbox" id="vocal-remover-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <!-- 音訊播放器 -->
        <div>
            <audio id="audio-player" controls crossorigin="anonymous" class="w-full"></audio>
        </div>

        <!-- 歌詞顯示區域 -->
        <div id="lyrics-container" class="lyrics-container bg-gray-900/50 rounded-lg p-4 text-center text-xl md:text-2xl font-medium overflow-y-auto">
            <div id="lyrics-content">
                <p class="text-gray-500">歌詞將會顯示在這裡...</p>
            </div>
        </div>
    </div>

    <script>
        // DOM 元素
        const audioInput = document.getElementById('audio-input');
        const lrcInput = document.getElementById('lrc-input');
        const audioPlayer = document.getElementById('audio-player');
        const lyricsContent = document.getElementById('lyrics-content');
        const audioFileName = document.getElementById('audio-file-name');
        const lrcFileName = document.getElementById('lrc-file-name');
        const vocalRemoverToggle = document.getElementById('vocal-remover-toggle');

        // Web Audio API 變數
        let audioContext;
        let sourceNode;
        let splitterNode;
        let gainNode;
        let mergerNode;
        let isVocalRemoverInitialized = false;

        // 歌詞相關變數
        let lyrics = [];
        let currentLineIndex = -1;
        
        // 初始化 Web Audio API (必須由使用者互動觸發)
        function initializeAudioContext() {
            if (audioContext) return;
            // 建立 AudioContext
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            // 從 <audio> 元素建立音源節點
            sourceNode = audioContext.createMediaElementSource(audioPlayer);
        }

        function setupVocalRemover() {
            if (!audioContext || !sourceNode) return;
            
            // 建立聲道分離器
            splitterNode = audioContext.createChannelSplitter(2);
            // 建立增益節點 (用來反相)
            gainNode = audioContext.createGain();
            gainNode.gain.value = -1; // 關鍵：將相位反轉 180 度
            // 建立聲道合併器
            mergerNode = audioContext.createChannelMerger(2);

            isVocalRemoverInitialized = true;
        }

        // 切換人聲消除狀態
        function toggleVocalRemoval(enabled) {
            // 確保 AudioContext 已被初始化
            initializeAudioContext();
            
            if (!isVocalRemoverInitialized) {
                setupVocalRemover();
            }

            // 中斷所有現有連接，避免聲音重複
            sourceNode.disconnect();

            if (enabled) {
                // 開啟人聲消除
                // 音源 -> 分離器
                sourceNode.connect(splitterNode);
                // 左聲道 -> 合併器左聲道
                splitterNode.connect(mergerNode, 0, 0);
                // 右聲道 -> 反相 -> 合併器右聲道
                splitterNode.connect(gainNode, 1);
                gainNode.connect(mergerNode, 0, 1);
                // 合併器 -> 輸出
                mergerNode.connect(audioContext.destination);
                console.log("人聲消除: 開啟");
            } else {
                // 關閉人聲消除 (恢復正常立體聲)
                sourceNode.connect(audioContext.destination);
                console.log("人聲消除: 關閉");
            }
        }

        vocalRemoverToggle.addEventListener('change', (e) => {
            toggleVocalRemoval(e.target.checked);
        });

        // 監聽音樂檔案選擇
        audioInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                audioPlayer.src = URL.createObjectURL(file);
                audioFileName.textContent = file.name;
                audioFileName.title = file.name;
                // 檔案改變後，重新連接音訊節點
                if (isVocalRemoverInitialized) {
                    toggleVocalRemoval(vocalRemoverToggle.checked);
                }
            }
        });
        
        // 第一次播放時，確保 AudioContext 被啟動
        audioPlayer.onplay = () => {
            initializeAudioContext();
            if(!isVocalRemoverInitialized) {
                // 如果是第一次播放且開關是打開的，則啟用效果
                if(vocalRemoverToggle.checked) {
                    toggleVocalRemoval(true);
                } else {
                    sourceNode.connect(audioContext.destination);
                }
            }
        };

        // --- 以下是歌詞處理邏輯，與前一版相同 ---

        lrcInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    lyrics = parseLRC(event.target.result);
                    renderLyrics();
                };
                reader.readAsText(file);
                lrcFileName.textContent = file.name;
                lrcFileName.title = file.name;
            }
        });

        function parseLRC(lrcContent) {
            const lines = lrcContent.split('\n');
            const parsedLyrics = [];
            const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            lines.forEach(line => {
                const match = line.match(timeRegex);
                if (match) {
                    const minutes = parseInt(match[1], 10);
                    const seconds = parseInt(match[2], 10);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
                    const time = minutes * 60 + seconds + milliseconds / 1000;
                    const text = line.replace(timeRegex, '').trim();
                    if (text) {
                        parsedLyrics.push({ time, text });
                    }
                }
            });
            return parsedLyrics.sort((a, b) => a.time - b.time);
        }

        function renderLyrics() {
            lyricsContent.innerHTML = '';
            if (lyrics.length === 0) {
                lyricsContent.innerHTML = '<p class="text-gray-500">歌詞檔案格式錯誤或為空。</p>';
                return;
            }
            lyrics.forEach((line, index) => {
                const p = document.createElement('p');
                p.textContent = line.text;
                p.classList.add('lyric-line');
                p.dataset.index = index;
                lyricsContent.appendChild(p);
            });
        }

        audioPlayer.addEventListener('timeupdate', () => {
            if (lyrics.length === 0) return;
            const currentTime = audioPlayer.currentTime;
            let newCurrentLineIndex = lyrics.findIndex(line => line.time > currentTime) - 1;
            if (newCurrentLineIndex < 0 && currentTime > lyrics[0].time) {
                newCurrentLineIndex = lyrics.length - 1;
            }
            if (newCurrentLineIndex < 0) newCurrentLineIndex = 0;

            if (newCurrentLineIndex !== currentLineIndex) {
                const oldLine = lyricsContent.querySelector(`[data-index="${currentLineIndex}"]`);
                if (oldLine) oldLine.classList.remove('active');
                const newLine = lyricsContent.querySelector(`[data-index="${newCurrentLineIndex}"]`);
                if (newLine) {
                    newLine.classList.add('active');
                    newLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                currentLineIndex = newCurrentLineIndex;
            }
        });

        audioPlayer.addEventListener('ended', () => {
             const oldLine = lyricsContent.querySelector(`[data-index="${currentLineIndex}"]`);
             if (oldLine) oldLine.classList.remove('active');
             currentLineIndex = -1;
        });
    </script>
</body>
</html>
