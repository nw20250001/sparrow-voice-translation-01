<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時語音翻譯機</title>
    <!-- 引入 Tailwind CSS 以進行樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 錄音按鈕的脈衝動畫 */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .is-recording {
            animation: pulse 2s infinite;
        }
        /* 頁面切換的淡入效果 */
        .page {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 卡片樣式 */
        .result-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1rem;
            min-height: 80px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen font-sans p-4">

    <!-- 頁面容器 -->
    <div id="appContainer" class="w-full max-w-2xl text-center">

        <!-- 頁面 1: 儀表板主頁 -->
        <div id="dashboardPage" class="page">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">即時語音翻譯機</h1>
            <p class="text-lg text-gray-400 mb-12">將您的中文或英文語音即時雙向翻譯。</p>
            <button id="goToTranslatorButton" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-full transition-transform duration-200 transform hover:scale-105 shadow-lg flex items-center justify-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="mr-3" viewBox="0 0 16 16">
                    <path d="m10.468 1.584a.5.5 0 0 0-.832-.34L6.021 4.12A3.5 3.5 0 0 0 4.5 6.866v2.268a3.5 3.5 0 0 0 1.521 2.746l3.615 2.888a.5.5 0 0 0 .832-.34V1.584z"/>
                    <path d="M16 8a7 7 0 1 1-14 0 7 7 0 0 1 14 0zM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0z"/>
                </svg>
                開始雙向翻譯
            </button>
            <p class="text-xs text-gray-600 mt-12">由 Gemini 模型提供翻譯支援</p>
        </div>

        <!-- 頁面 2: 翻譯功能頁面 -->
        <div id="translatorPage" class="page">
            <h1 class="text-3xl md:text-4xl font-bold mb-6">語音翻譯</h1>
            
            <button id="recordButton" class="w-48 h-48 md:w-56 md:h-56 bg-sky-600 rounded-full flex flex-col items-center justify-center text-xl font-bold text-white select-none transition-all duration-300 ease-in-out transform focus:outline-none shadow-lg hover:bg-sky-500 active:scale-95 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-mic-fill mb-2" viewBox="0 0 16 16">
                    <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                    <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                </svg>
                <span id="recordButtonText">按住說話</span>
            </button>

            <div id="status" class="mt-6 text-lg text-yellow-400 h-8 font-medium"></div>

            <!-- 結果顯示區 -->
            <div class="w-full mt-4">
                <div class="grid grid-cols-1 md:grid-cols-[1fr,auto,1fr] gap-4 items-center">
                    <!-- 來源語言卡片 -->
                    <div class="result-card order-1">
                         <h2 id="sourceTitle" class="font-bold text-lg text-gray-300 mb-2"></h2>
                         <p id="originalText" class="text-gray-200"></p>
                    </div>
                    
                    <!-- 切換按鈕 -->
                    <div class="order-2 flex justify-center">
                        <button id="swapButton" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition-transform duration-200 transform hover:rotate-180 focus:outline-none" title="切換語言">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/>
                            </svg>
                        </button>
                    </div>
            
                    <!-- 目標語言卡片 -->
                    <div class="result-card relative order-3">
                         <h2 id="targetTitle" class="font-bold text-lg text-gray-300 mb-2"></h2>
                         <p id="translatedText" class="text-teal-300 pr-10"></p>
                         <button id="copyButton" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-gray-700 focus:outline-none" title="複製翻譯結果">
                             <svg id="copyIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                             <svg id="checkIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-check-lg hidden text-green-400" viewBox="0 0 16 16">
                                <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/>
                             </svg>
                         </button>
                    </div>
                </div>
            </div>
            
            <button id="backToDashboardButton" class="mt-8 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-full transition-transform duration-200 transform hover:scale-105 shadow-lg">
                返回主頁
            </button>
        </div>
    </div>

    <script>
        // --- DOM 元素 ---
        const pages = document.querySelectorAll('.page');
        const dashboardPage = document.getElementById('dashboardPage');
        const translatorPage = document.getElementById('translatorPage');
        const goToTranslatorButton = document.getElementById('goToTranslatorButton');
        const backToDashboardButton = document.getElementById('backToDashboardButton');
        const recordButton = document.getElementById('recordButton');
        const recordButtonText = document.getElementById('recordButtonText');
        const statusDiv = document.getElementById('status');
        const originalTextDiv = document.getElementById('originalText');
        const translatedTextDiv = document.getElementById('translatedText');
        const swapButton = document.getElementById('swapButton');
        const copyButton = document.getElementById('copyButton');
        const copyIcon = document.getElementById('copyIcon');
        const checkIcon = document.getElementById('checkIcon');
        const sourceTitle = document.getElementById('sourceTitle');
        const targetTitle = document.getElementById('targetTitle');

        // --- API & 狀態變數 ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;
        let englishVoices = [];
        let chineseVoices = [];
        let sourceLang = 'zh'; // 'zh' 或 'en'

        // --- 頁面導航 ---
        const showPage = (pageId) => {
            pages.forEach(page => page.style.display = 'none');
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.style.display = 'block';
        };

        // --- 核心功能 ---

        // 1. 更新 UI 語言顯示
        const updateUIForLanguage = () => {
            if (sourceLang === 'zh') {
                sourceTitle.textContent = '您說的 (中文):';
                targetTitle.textContent = '翻譯結果 (英文):';
                recordButtonText.textContent = '按住說話';
                if (recognition) recognition.lang = 'cmn-Hant-TW'; // 繁體中文(台灣)
            } else {
                sourceTitle.textContent = 'You said (English):';
                targetTitle.textContent = '翻譯結果 (繁體中文):';
                recordButtonText.textContent = 'Hold to Speak';
                if (recognition) recognition.lang = 'en-US';
            }
            originalTextDiv.textContent = '';
            translatedTextDiv.textContent = '';
            statusDiv.textContent = '';
        };

        // 2. 初始化語音辨識
        const setupSpeechRecognition = () => {
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    isRecording = true;
                    statusDiv.textContent = sourceLang === 'zh' ? '請開始說話...' : 'Listening...';
                    recordButton.classList.add('bg-red-600', 'is-recording');
                    recordButton.classList.remove('bg-sky-600');
                    recordButtonText.textContent = sourceLang === 'zh' ? '聆聽中...' : 'Listening...';
                };

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    statusDiv.textContent = '辨識完成，正在翻譯...';
                    originalTextDiv.textContent = speechResult;
                    translatedTextDiv.textContent = '...';
                    translateText(speechResult);
                };

                recognition.onend = () => {
                    isRecording = false;
                    recordButton.classList.remove('bg-red-600', 'is-recording');
                    recordButton.classList.add('bg-sky-600');
                    updateUIForLanguage(); // 重設按鈕文字
                };
                
                recognition.onerror = (event) => {
                    statusDiv.textContent = `語音辨識錯誤: ${event.error}`;
                };
                
                updateUIForLanguage(); // 初始設定語言

            } else {
                statusDiv.textContent = "抱歉，您的瀏覽器不支援語音辨識功能。";
                recordButton.disabled = true;
            }
        };

        // 3. 翻譯文字 (使用 Gemini API)
        const translateText = async (textToTranslate) => {
            const apiKey = ""; // 將由環境自動提供
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const sourceLangName = sourceLang === 'zh' ? 'Traditional Chinese' : 'English';
            const targetLangName = sourceLang === 'zh' ? 'English' : 'Traditional Chinese';
            const prompt = `Translate the following ${sourceLangName} text to ${targetLangName}. Provide only the translated text, without any introductory phrases, quotation marks, or explanations. Text: "${textToTranslate}"`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                }

                const result = await response.json();
                const translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text.trim() || "翻譯失敗。";
                
                statusDiv.textContent = '翻譯完成！';
                translatedTextDiv.textContent = translatedText;
                speakResult(translatedText);

            } catch (error) {
                console.error("翻譯錯誤:", error);
                statusDiv.textContent = "翻譯時發生錯誤。";
                translatedTextDiv.textContent = "N/A";
            }
        };
        
        // 4. 載入並篩選語音
        const loadVoices = () => {
            const allVoices = speechSynthesis.getVoices();
            englishVoices = allVoices.filter(voice => voice.lang.startsWith('en-'));
            chineseVoices = allVoices.filter(voice => voice.lang.startsWith('zh-'));
        };

        // 5. 播放翻譯結果
        const speakResult = (text) => {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const targetLang = sourceLang === 'zh' ? 'en' : 'zh';

                if (targetLang === 'en') {
                    utterance.lang = 'en-US';
                    const preferredVoice = englishVoices.find(v => v.name === 'Google US English') || englishVoices.find(v => v.lang === 'en-US') || englishVoices[0];
                    if (preferredVoice) utterance.voice = preferredVoice;
                } else {
                    utterance.lang = 'zh-TW';
                    const preferredVoice = chineseVoices.find(v => v.name === 'Google 國語（臺灣）') || chineseVoices.find(v => v.lang === 'zh-TW') || chineseVoices[0];
                    if (preferredVoice) utterance.voice = preferredVoice;
                }
                
                speechSynthesis.speak(utterance);
            } else {
                statusDiv.textContent = "抱歉，您的瀏覽器不支援語音合成功能。";
            }
        };

        // 6. 複製到剪貼簿
        const copyToClipboard = () => {
            const text = translatedTextDiv.textContent;
            if (text && text !== '...' && text !== 'N/A') {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'absolute';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    statusDiv.textContent = '翻譯結果已複製！';
                    copyIcon.classList.add('hidden');
                    checkIcon.classList.remove('hidden');
                    setTimeout(() => {
                        copyIcon.classList.remove('hidden');
                        checkIcon.classList.add('hidden');
                        if (statusDiv.textContent === '翻譯結果已複製！') statusDiv.textContent = '';
                    }, 2000);
                } catch (err) {
                    console.error('無法複製文字:', err);
                    statusDiv.textContent = '複製失敗。';
                }
                document.body.removeChild(textArea);
            }
        };

        // --- 事件監聽器 ---
        goToTranslatorButton.addEventListener('click', () => showPage('translatorPage'));
        backToDashboardButton.addEventListener('click', () => {
            if (isRecording) recognition.stop();
            speechSynthesis.cancel();
            showPage('dashboardPage');
        });

        swapButton.addEventListener('click', () => {
            sourceLang = sourceLang === 'zh' ? 'en' : 'zh';
            updateUIForLanguage();
        });

        copyButton.addEventListener('click', copyToClipboard);

        const startRecognition = (e) => {
            e.preventDefault();
            if (!isRecording && recognition) {
                try {
                    recognition.start();
                } catch(err) {
                    console.error("無法啟動語音辨識:", err);
                    statusDiv.textContent = "辨識功能啟動失敗，請稍後再試。";
                }
            }
        };

        const stopRecognition = () => {
            if (isRecording && recognition) {
                recognition.stop();
            }
        };

        recordButton.addEventListener('mousedown', startRecognition);
        recordButton.addEventListener('mouseup', stopRecognition);
        recordButton.addEventListener('mouseleave', stopRecognition); // 如果滑鼠移開也停止
        recordButton.addEventListener('touchstart', startRecognition, { passive: false });
        recordButton.addEventListener('touchend', stopRecognition);

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            setupSpeechRecognition();
            showPage('dashboardPage');
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        });
    </script>
</body>
</html>
