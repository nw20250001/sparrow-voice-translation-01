<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時語音翻譯機</title>
    <!-- 引入 Tailwind CSS 以進行樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 錄音按鈕的脈衝動畫 */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .is-recording {
            animation: pulse 2s infinite;
        }
        /* 頁面切換的淡入效果 */
        .page {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 卡片樣式 */
        .result-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1rem;
            margin-top: 1rem;
            min-height: 80px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen font-sans p-4">

    <!-- 頁面容器 -->
    <div id="appContainer" class="w-full max-w-lg text-center">

        <!-- 頁面 1: 儀表板主頁 -->
        <div id="dashboardPage" class="page">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">即時語音翻譯機</h1>
            <p class="text-lg text-gray-400 mb-12">將您的中文語音即時翻譯成流利的英文。</p>
            <button id="goToTranslatorButton" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-full transition-transform duration-200 transform hover:scale-105 shadow-lg flex items-center justify-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="mr-3" viewBox="0 0 16 16">
                    <path d="m10.468 1.584a.5.5 0 0 0-.832-.34L6.021 4.12A3.5 3.5 0 0 0 4.5 6.866v2.268a3.5 3.5 0 0 0 1.521 2.746l3.615 2.888a.5.5 0 0 0 .832-.34V1.584z"/>
                    <path d="M16 8a7 7 0 1 1-14 0 7 7 0 0 1 14 0zM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0z"/>
                </svg>
                開啟語音翻譯功能
            </button>
            <p class="text-xs text-gray-600 mt-12">由 Gemini 模型提供翻譯支援</p>
        </div>

        <!-- 頁面 2: 翻譯功能頁面 -->
        <div id="translatorPage" class="page">
            <h1 class="text-3xl md:text-4xl font-bold mb-6">語音翻譯</h1>
            
            <button id="recordButton" class="w-48 h-48 md:w-56 md:h-56 bg-sky-600 rounded-full flex flex-col items-center justify-center text-xl font-bold text-white select-none transition-all duration-300 ease-in-out transform focus:outline-none shadow-lg hover:bg-sky-500 active:scale-95 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-mic-fill mb-2" viewBox="0 0 16 16">
                    <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                    <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                </svg>
                <span id="recordButtonText">按住說話</span>
            </button>

            <div id="status" class="mt-6 text-lg text-yellow-400 h-8 font-medium"></div>

            <!-- 結果顯示區 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 w-full">
                <div class="result-card">
                    <h2 class="font-bold text-lg text-gray-300 mb-2">您說的 (中文):</h2>
                    <p id="originalText" class="text-gray-200"></p>
                </div>
                <div class="result-card">
                    <h2 class="font-bold text-lg text-gray-300 mb-2">翻譯結果 (英文):</h2>
                    <p id="translatedText" class="text-teal-300"></p>
                </div>
            </div>
            
            <button id="backToDashboardButton" class="mt-8 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-full transition-transform duration-200 transform hover:scale-105 shadow-lg">
                返回主頁
            </button>
        </div>
    </div>

    <script>
        // --- DOM 元素 ---
        const pages = document.querySelectorAll('.page');
        const dashboardPage = document.getElementById('dashboardPage');
        const translatorPage = document.getElementById('translatorPage');
        const goToTranslatorButton = document.getElementById('goToTranslatorButton');
        const backToDashboardButton = document.getElementById('backToDashboardButton');
        const recordButton = document.getElementById('recordButton');
        const recordButtonText = document.getElementById('recordButtonText');
        const statusDiv = document.getElementById('status');
        const originalTextDiv = document.getElementById('originalText');
        const translatedTextDiv = document.getElementById('translatedText');

        // --- API & 狀態變數 ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;
        let englishVoices = [];

        // --- 頁面導航 ---
        const showPage = (pageId) => {
            pages.forEach(page => page.style.display = 'none');
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.style.display = 'block';
        };

        // --- 核心功能 ---

        // 1. 初始化語音辨識
        const setupSpeechRecognition = () => {
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'cmn-Hant-TW'; // 繁體中文(台灣)
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    isRecording = true;
                    statusDiv.textContent = '請開始說話...';
                    recordButton.classList.add('bg-red-600', 'is-recording');
                    recordButton.classList.remove('bg-sky-600');
                    recordButtonText.textContent = '聆聽中...';
                };

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    statusDiv.textContent = '辨識完成，正在翻譯...';
                    originalTextDiv.textContent = speechResult;
                    translatedTextDiv.textContent = '...';
                    translateText(speechResult);
                };

                recognition.onend = () => {
                    isRecording = false;
                    recordButton.classList.remove('bg-red-600', 'is-recording');
                    recordButton.classList.add('bg-sky-600');
                    recordButtonText.textContent = '按住說話';
                };
                
                recognition.onerror = (event) => {
                    statusDiv.textContent = `語音辨識錯誤: ${event.error}`;
                };

            } else {
                statusDiv.textContent = "抱歉，您的瀏覽器不支援語音辨識功能。";
            }
        };

        // 2. 翻譯文字 (使用 Gemini API)
        const translateText = async (textToTranslate) => {
            const apiKey = ""; // 將由環境自動提供
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `Please translate the following Traditional Chinese text into English. Provide only the translated text, without any introductory phrases or explanations. Text: "${textToTranslate}"`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                }

                const result = await response.json();
                const translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text.trim() || "翻譯失敗。";
                
                statusDiv.textContent = '翻譯完成！';
                translatedTextDiv.textContent = translatedText;
                speakEnglish(translatedText);

            } catch (error) {
                console.error("翻譯錯誤:", error);
                statusDiv.textContent = "翻譯時發生錯誤。";
                translatedTextDiv.textContent = "N/A";
            }
        };
        
        // 3. 載入並篩選英文語音
        const loadVoices = () => {
            englishVoices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en-'));
        };

        // 4. 播放英文語音
        const speakEnglish = (text) => {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel(); // 取消先前的播放
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                
                // 優先選擇美式或英式發音
                const preferredVoice = englishVoices.find(voice => voice.name === 'Google US English') || englishVoices.find(voice => voice.lang === 'en-US') || englishVoices[0];
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                speechSynthesis.speak(utterance);
            } else {
                statusDiv.textContent = "抱歉，您的瀏覽器不支援語音合成功能。";
            }
        };

        // --- 事件監聽器 ---
        goToTranslatorButton.addEventListener('click', () => showPage('translatorPage'));
        backToDashboardButton.addEventListener('click', () => {
            if (isRecording) recognition.stop();
            speechSynthesis.cancel();
            showPage('dashboardPage');
        });

        recordButton.addEventListener('mousedown', () => {
            if (!isRecording) recognition.start();
        });
        recordButton.addEventListener('mouseup', () => {
            if (isRecording) recognition.stop();
        });
        recordButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!isRecording) recognition.start();
        });
        recordButton.addEventListener('touchend', () => {
            if (isRecording) recognition.stop();
        });


        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            setupSpeechRecognition();
            showPage('dashboardPage');
            // 語音列表需要時間載入，我們預先載入
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        });
    </script>
</body>
</html>
