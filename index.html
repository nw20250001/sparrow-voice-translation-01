<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時語音翻譯系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .pulse-red {
            animation: pulse-red-animation 2s infinite;
        }
        @keyframes pulse-red-animation {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .output-box { min-height: 120px; }
        .lang-label {
            position: absolute;
            top: -12px;
            left: 16px;
            background-color: #1f2937; /* Match the card background */
            padding: 0 8px;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        .btn-transition {
            transition: background-color 0.3s ease-in-out, transform 0.2s ease;
        }
        /* For custom scrollbar */
        #historyContainer::-webkit-scrollbar { width: 6px; }
        #historyContainer::-webkit-scrollbar-track { background: #1f2937; }
        #historyContainer::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px;}
        #historyContainer::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <!-- Translator Card -->
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 relative mb-6">
            <header class="flex justify-between items-center mb-6">
                <h1 id="modeTitle" class="text-2xl font-bold text-white">中文 → 英文</h1>
                <button id="toggleModeBtn" title="切換翻譯方向" class="p-2 rounded-full hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                </button>
            </header>

            <main class="space-y-6">
                <div class="relative border border-gray-600 rounded-lg p-4 bg-gray-900 output-box">
                    <span id="originalLangLabel" class="lang-label">原文 (中文)</span>
                    <p id="originalText" class="text-gray-300"></p>
                </div>
                <div class="relative border border-gray-600 rounded-lg p-4 bg-gray-900 output-box">
                    <span id="translatedLangLabel" class="lang-label">翻譯 (英文)</span>
                    <p id="translatedText" class="text-blue-300 font-medium"></p>
                </div>
            </main>
            
            <footer class="mt-8 flex flex-col items-center">
                <div id="status" class="text-center text-blue-400 h-6 mb-4">點擊下方按鈕開始</div>
                <button id="micBtn" class="w-20 h-20 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg transform hover:scale-110 focus:outline-none btn-transition">
                    <div id="micIconContainer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.944A5.962 5.962 0 0110 5a5.962 5.962 0 015.668 3.944.5.5 0 01-.998.056A4.962 4.962 0 0010 6a4.962 4.962 0 00-4.668 2.999.5.5 0 11-.998-.055z" clip-rule="evenodd" /><path d="M10 15a4 4 0 004-4h-1.5a2.5 2.5 0 01-5 0H6a4 4 0 004 4z" /></svg>
                    </div>
                </button>
                <p class="text-center mt-6 text-gray-500 text-xs">由 Gemini AI 提供技術支援</p>
            </footer>
        </div>

        <!-- History Card -->
        <div id="historySection" class="bg-gray-800 rounded-2xl shadow-2xl p-6">
            <h2 class="text-xl font-bold text-white mb-4">翻譯紀錄</h2>
            <div id="historyContainer" class="max-h-64 overflow-y-auto space-y-3 pr-2">
                <!-- Translation history will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // DOM 元素
        const modeTitle = document.getElementById('modeTitle'),
              toggleModeBtn = document.getElementById('toggleModeBtn'),
              originalLangLabel = document.getElementById('originalLangLabel'),
              translatedLangLabel = document.getElementById('translatedLangLabel'),
              originalText = document.getElementById('originalText'),
              translatedText = document.getElementById('translatedText'),
              status = document.getElementById('status'),
              micBtn = document.getElementById('micBtn'),
              micIconContainer = document.getElementById('micIconContainer'),
              historyContainer = document.getElementById('historyContainer');

        // 圖示 SVG
        const micIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.944A5.962 5.962 0 0110 5a5.962 5.962 0 015.668 3.944.5.5 0 01-.998.056A4.962 4.962 0 0010 6a4.962 4.962 0 00-4.668 2.999.5.5 0 11-.998-.055z" clip-rule="evenodd" /><path d="M10 15a4 4 0 004-4h-1.5a2.5 2.5 0 01-5 0H6a4 4 0 004 4z" /></svg>`,
              stopIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>`,
              speakerIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.102A6.9 6.9 0 003.102 10 6.9 6.9 0 0010 16.898 6.9 6.9 0 0016.898 10 6.9 6.9 0 0010 3.102zM1.102 10a8.9 8.9 0 018.9-8.9 8.9 8.9 0 018.9 8.9 8.9 8.9 0 01-8.9 8.9A8.9 8.9 0 011.102 10z" /><path d="M10 5.5a4.5 4.5 0 00-4.5 4.5H7A2.5 2.5 0 019.5 7.5v-2z" /></svg>`,
              deleteIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;

        // 應用程式狀態
        let currentMode = 'zh-to-en', isListening = false, translationHistory = [];
        
        // 語音 API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition,
              synthesis = window.speechSynthesis;
        let recognition = null;

        if (!SpeechRecognition) { status.textContent = "瀏覽器不支援語音功能"; micBtn.disabled = true; }
        
        // Gemini API 設定
        const API_KEY = ""; // 如有需要，請填寫您的金鑰
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        async function translateText(text, sourceLang, targetLang) {
            const prompt = `Translate the following text from ${sourceLang} to ${targetLang}. Provide only the translated text, without any additional explanations or context.\n\nText: "${text}"\n\nTranslation:`;
            try {
                let response, attempts = 0, maxAttempts = 5, delay = 1000;
                while (attempts < maxAttempts) {
                    response = await fetch(API_URL, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            safetySettings: [
                                { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                                { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                                { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                                { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                            ]
                        })
                    });
                    if (response.ok) break;
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; attempts++;
                    } else throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                }
                if (!response.ok) throw new Error(`API 請求在 ${maxAttempts} 次嘗試後失敗。`);
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text.trim();
                } else { console.error("API 回應結構異常:", result); return "翻譯時發生錯誤。"; }
            } catch (error) { console.error('翻譯錯誤:', error); return "翻譯失敗，請檢查網路連線。"; }
        }
        
        function speakText(text, lang) {
            if (synthesis.speaking) synthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            synthesis.speak(utterance);
        }

        function formatDate(date) {
            const pad = (num) => num.toString().padStart(2, '0');
            const YYYY = date.getFullYear();
            const MM = pad(date.getMonth() + 1);
            const DD = pad(date.getDate());
            const hh = pad(date.getHours());
            const mm = pad(date.getMinutes());
            const ss = pad(date.getSeconds());
            return `${YYYY}/${MM}/${DD} ${hh}:${mm}:${ss}`;
        }

        function renderHistory() {
            historyContainer.innerHTML = '';
            if (translationHistory.length === 0) {
                historyContainer.innerHTML = `<p class="text-gray-500 text-center">此處會顯示您的翻譯紀錄。</p>`;
                return;
            }
            translationHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-gray-700 p-3 rounded-lg flex items-start';
                historyItem.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-xs text-gray-400 mb-1">${item.timestamp}</p>
                        <p class="text-sm text-gray-300">${item.original}</p>
                        <p class="text-sm text-blue-300 font-semibold">${item.translated}</p>
                    </div>
                    <div class="flex flex-col space-y-2 ml-2">
                        <button class="replay-btn p-2 rounded-full hover:bg-gray-600 transition-colors" title="重新播放" data-text="${item.translated.replace(/"/g, '&quot;')}" data-lang="${item.lang}">
                            ${speakerIcon}
                        </button>
                        <button class="delete-btn p-2 rounded-full text-gray-400 hover:text-red-400 hover:bg-gray-600 transition-colors" title="刪除紀錄" data-id="${item.id}">
                           ${deleteIcon}
                        </button>
                    </div>
                `;
                historyContainer.appendChild(historyItem);
            });
        }

        function updateUIForMode() {
            modeTitle.textContent = (currentMode === 'zh-to-en') ? '中文 → 英文' : '英文 → 中文';
            originalLangLabel.textContent = (currentMode === 'zh-to-en') ? '原文 (中文)' : '原文 (英文)';
            translatedLangLabel.textContent = (currentMode === 'zh-to-en') ? '翻譯 (英文)' : '翻譯 (中文)';
            originalText.textContent = ''; translatedText.textContent = '';
        }
        
        async function handleFinalTranscript(finalTranscript) {
            if (!finalTranscript) return;

            translatedText.textContent = '翻譯中...';
            const targetLang = (currentMode === 'zh-to-en') ? 'English' : 'Traditional Chinese';
            const sourceLang = (currentMode === 'zh-to-en') ? 'Traditional Chinese' : 'English';
            const translatedResult = await translateText(finalTranscript, sourceLang, targetLang);
            
            translatedText.textContent = translatedResult;
            const speakLang = (currentMode === 'zh-to-en') ? 'en-US' : 'zh-TW';
            speakText(translatedResult, speakLang);

            const now = new Date();
            const historyEntry = {
                id: now.getTime(),
                timestamp: formatDate(now),
                original: finalTranscript,
                translated: translatedResult,
                lang: speakLang
            };
            translationHistory.unshift(historyEntry);
            if (translationHistory.length > 50) translationHistory.pop(); // 只保留最近50筆紀錄
            renderHistory();
        }

        function startListening() {
            isListening = true;
            toggleModeBtn.disabled = true;
            micBtn.classList.remove('bg-blue-600');
            micBtn.classList.add('bg-red-600', 'pulse-red');
            micIconContainer.innerHTML = stopIcon;

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = (currentMode === 'zh-to-en') ? 'cmn-Hant-TW' : 'en-US';
            status.textContent = (currentMode === 'zh-to-en') ? '正在聆聽...' : 'Listening...';
            
            let finalTranscript = '';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                originalText.textContent = finalTranscript + interimTranscript;
            };
            
            recognition.onend = () => {
                handleFinalTranscript(finalTranscript.trim());
                stopListening();
            };
            recognition.onerror = (event) => { console.error('語音辨識錯誤:', event.error); status.textContent = `錯誤: ${event.error}`; stopListening(); };
            recognition.start();
        }

        function stopListening() {
            if (!isListening) return;
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            isListening = false;
            toggleModeBtn.disabled = false;
            micBtn.classList.remove('bg-red-600', 'pulse-red');
            micBtn.classList.add('bg-blue-600');
            micIconContainer.innerHTML = micIcon;
            status.textContent = '點擊下方按鈕開始';
        }

        // 事件監聽器
        micBtn.addEventListener('click', () => { if (!isListening) startListening(); else stopListening(); });
        toggleModeBtn.addEventListener('click', () => { if (isListening) return; currentMode = (currentMode === 'zh-to-en') ? 'en-to-zh' : 'zh-to-en'; updateUIForMode(); });
        historyContainer.addEventListener('click', (event) => {
            const targetButton = event.target.closest('button');
            if (!targetButton) return;

            if (targetButton.classList.contains('replay-btn')) {
                speakText(targetButton.dataset.text, targetButton.dataset.lang);
            } else if (targetButton.classList.contains('delete-btn')) {
                const idToDelete = parseInt(targetButton.dataset.id, 10);
                translationHistory = translationHistory.filter(item => item.id !== idToDelete);
                renderHistory();
            }
        });

        // 初始設定
        synthesis.onvoiceschanged = () => { console.log("聲音引擎已載入。"); };
        renderHistory();
    </script>
</body>
</html>
